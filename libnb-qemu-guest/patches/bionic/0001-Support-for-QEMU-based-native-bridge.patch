From cf3ee711c615e2af6647c7e64d10c425cff3e0c8 Mon Sep 17 00:00:00 2001
From: Michael Goffioul <michael.goffioul@lincor.com>
Date: Thu, 21 Nov 2019 19:22:39 -0500
Subject: [PATCH] Support for QEMU-based native bridge

Change-Id: I9f79292e64dab0f9382a6ee08a62c0cc56a1ee39
---
 libc/bionic/pthread_create.cpp | 26 ++++++++++++++++++++++++++
 libc/bionic/pthread_exit.cpp   | 24 ++++++++++++++++++++++++
 libc/libc.map.txt              |  3 +++
 libc/private/bionic_fortify.h  |  2 +-
 linker/linker.cpp              | 10 ++++++----
 linker/linker_phdr.cpp         |  2 ++
 6 files changed, 62 insertions(+), 5 deletions(-)

diff --git a/libc/bionic/pthread_create.cpp b/libc/bionic/pthread_create.cpp
index 4cf14ad72..3a857bbf4 100644
--- a/libc/bionic/pthread_create.cpp
+++ b/libc/bionic/pthread_create.cpp
@@ -428,3 +428,29 @@ int pthread_create(pthread_t* thread_out, pthread_attr_t const* attr,
 
   return 0;
 }
+
+extern "C"
+int __pthread_allocate_self(void **stack, void **tls) {
+  pthread_attr_t attr;
+  pthread_attr_init(&attr);
+  pthread_attr_setdetachstate(&attr, PTHREAD_CREATE_DETACHED);
+
+  bionic_tcb* tcb = nullptr;
+  void* child_stack = nullptr;
+  int result = __allocate_thread(&attr, &tcb, &child_stack);
+  if (result != 0) {
+      return result;
+  }
+
+  pthread_internal_t* thread = tcb->thread();
+
+  thread->set_cached_pid(getpid());
+  thread->tid = __get_thread()->tid;
+  __init_thread(thread);
+  __pthread_internal_add(thread);
+
+  *stack = child_stack;
+  *tls = &tcb->tls_slot(0);
+
+  return 0;
+}
diff --git a/libc/bionic/pthread_exit.cpp b/libc/bionic/pthread_exit.cpp
index 3b873b314..b3bc2b5a8 100644
--- a/libc/bionic/pthread_exit.cpp
+++ b/libc/bionic/pthread_exit.cpp
@@ -138,3 +138,27 @@ void pthread_exit(void* return_value) {
   __hwasan_thread_exit();
   __exit(0);
 }
+
+extern "C"
+void __pthread_deallocate_self(void **stack, size_t *size) {
+  __cxa_thread_finalize();
+
+  pthread_internal_t* thread = __get_thread();
+
+  while (thread->cleanup_stack) {
+    __pthread_cleanup_t* c = thread->cleanup_stack;
+    thread->cleanup_stack = c->__cleanup_prev;
+    c->__cleanup_routine(c->__cleanup_arg);
+  }
+
+  pthread_key_clean_all();
+
+  ScopedSignalBlocker ssb;
+
+  __free_dynamic_tls(__get_bionic_tcb());
+  __set_tid_address(nullptr);
+  __pthread_internal_remove(thread);
+
+  *stack = thread->mmap_base;
+  *size = thread->mmap_size;
+}
diff --git a/libc/libc.map.txt b/libc/libc.map.txt
index 88192239a..d47e30086 100644
--- a/libc/libc.map.txt
+++ b/libc/libc.map.txt
@@ -1478,6 +1478,9 @@ LIBC_Q { # introduced=Q
 
     # Used by libandroid_runtime, libmedia and libmediautils
     android_mallopt; # apex
+
+    __pthread_allocate_self;
+    __pthread_deallocate_self;
 } LIBC_P;
 
 LIBC_PRIVATE {
diff --git a/libc/private/bionic_fortify.h b/libc/private/bionic_fortify.h
index 3c3292e58..55064a936 100644
--- a/libc/private/bionic_fortify.h
+++ b/libc/private/bionic_fortify.h
@@ -38,7 +38,7 @@
 static inline __noreturn void __fortify_fatal(const char* fmt, ...) {
   va_list args;
   va_start(args, fmt);
-  async_safe_fatal_va_list("FORTIFY", fmt, args);
+  async_safe_fatal_va_list("FORTIFY [arm]", fmt, args);
   va_end(args);
   abort();
 }
diff --git a/linker/linker.cpp b/linker/linker.cpp
index b59df7302..5b7c79408 100644
--- a/linker/linker.cpp
+++ b/linker/linker.cpp
@@ -85,10 +85,10 @@ static LinkerTypeAllocator<LinkedListEntry<soinfo>> g_soinfo_links_allocator;
 static LinkerTypeAllocator<android_namespace_t> g_namespace_allocator;
 static LinkerTypeAllocator<LinkedListEntry<android_namespace_t>> g_namespace_list_allocator;
 
-static const char* const kLdConfigArchFilePath = "/system/etc/ld.config." ABI_STRING ".txt";
+static const char* const kLdConfigArchFilePath = "/system/lib/arm/ld.config." ABI_STRING ".txt";
 
-static const char* const kLdConfigFilePath = "/system/etc/ld.config.txt";
-static const char* const kLdConfigVndkLiteFilePath = "/system/etc/ld.config.vndk_lite.txt";
+static const char* const kLdConfigFilePath = "/system/lib/arm/ld.config.txt";
+static const char* const kLdConfigVndkLiteFilePath = "/system/lib/arm/ld.config.vndk_lite.txt";
 
 #if defined(__LP64__)
 static const char* const kSystemLibDir        = "/system/lib64";
@@ -99,7 +99,8 @@ static const char* const kAsanOdmLibDir       = "/data/asan/odm/lib64";
 static const char* const kAsanVendorLibDir    = "/data/asan/vendor/lib64";
 static const char* const kRuntimeApexLibDir   = "/apex/com.android.runtime/lib64";
 #else
-static const char* const kSystemLibDir        = "/system/lib";
+static const char* const kSystemLibDir        = "/system/lib/arm";
+static const char* const kSystemNbLibDir      = "/system/lib/arm/nb";
 static const char* const kOdmLibDir           = "/odm/lib";
 static const char* const kVendorLibDir        = "/vendor/lib";
 static const char* const kAsanSystemLibDir    = "/data/asan/system/lib";
@@ -111,6 +112,7 @@ static const char* const kRuntimeApexLibDir   = "/apex/com.android.runtime/lib";
 static const char* const kAsanLibDirPrefix = "/data/asan";
 
 static const char* const kDefaultLdPaths[] = {
+  kSystemNbLibDir,
   kSystemLibDir,
   kOdmLibDir,
   kVendorLibDir,
diff --git a/linker/linker_phdr.cpp b/linker/linker_phdr.cpp
index 353428730..5c483ceed 100644
--- a/linker/linker_phdr.cpp
+++ b/linker/linker_phdr.cpp
@@ -656,6 +656,8 @@ bool ElfReader::LoadSegments() {
         DL_ERR("couldn't map \"%s\" segment %zd: %s", name_.c_str(), i, strerror(errno));
         return false;
       }
+      INFO("[ map: %p - %p  %08x  %016llx - %s ]",
+           seg_addr, reinterpret_cast<char *>(seg_addr) + file_length, file_length, file_offset_ + file_page_start, name_.c_str());
     }
 
     // if the segment is writable, and does not end on a page boundary,
-- 
2.21.0

